---
title: "Logistic Regression Model"
author: "msurdek"
date: "9/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(width = 100)
```

```{r, message=FALSE, warnings=FALSE, results=FALSE}
library(dplyr)
library(ggplot2)
library(tidymodels)
library(recipes)
library(forcats)
library(tidytext)
library(readr)
library(pastecs)
library(moments)
```

```{r}
churn_data <- read_csv("/home/msurdek/Documents/School/SNHU/DAT 690 Capstone in Data Analytics/Assignments/Project/Data/Churn Data.csv") |> 
  mutate(CHURN = as.factor(CHURN)) |> 
  rename(PRZM_NUM = 'Column 45') |> 
  mutate(CSA_main = substr(CSA,1,3))

#5
id_vars <- c('CUSTOMER','CHURNDEP','CALIBRAT','OCC','MARRY')
#1
target_vars <- c('CHURN')
#16
usage_vars <- c('MOU','OVERAGE','ROAM','CHANGEM','BLCKVCE','UNANSVCE','THREEWAY','MOUREC','OUTCALLS','INCALLS','PEAKVCE','OPEAKVCE','CALLFWDV','CALLWAIT','NEWCELLY','NEWCELLN')
#2
coverage_vars <- c('DROPVCE','DROPBLK')
#6
sub_vars <- c('REVENUE','RECCHRGE','CHANGER','MONTHS','UNIQSUBS','ACTVSUBS')
#9
service_vars <- c('DIRECTAS','CUSTCARE','MAILORD','MAILRES','MAILFLAG','RETCALLS','RETACCPT','REFER','RETCALL')
#7
eq_vars <- c('PHONES','MODELS','EQPDAYS','REFURB','WEBCAP','SETPRCM','SETPRC')
#4
dem_vars_label <- c('CREDIT_RATING','PRZM_NUM','OCC_LABEL','MARRY_LABEL')
#20
dem_vars_dich <- c('CREDITA', 'CREDITAA', 'CREDITB', 'CREDITC', 'CREDITDE', 'CREDITGY', 'CREDITZ', 'PRIZMRUR', 'PRIZMUB', 'PRIZMTWN', 'OCCPROF', 'OCCCLER', 'OCCCRFT', 'OCCSTUD', 'OCCHMKR', 'OCCRET', 'OCCSELF', 'MARRYUN', 'MARRYYES', 'MARRYNO')
#15
dem_vars_other <- c('AGE1','AGE2','CHILDREN','TRUCK','RV','OWNRENT','TRAVEL','PCOWN','CREDITCD','INCMISS','INCOME','MCYCLE','CREDITAD')

location_vars <- c('CSA','CSA_main')

data <- churn_data |>
  select(c(target_vars,usage_vars,coverage_vars,sub_vars,service_vars,eq_vars,dem_vars_label,dem_vars_other)) |> 
  na.omit()

all_data <- churn_data |>
  select(c(target_vars,usage_vars,coverage_vars,sub_vars,service_vars,eq_vars,dem_vars_label,dem_vars_other))

summary(all_data)

cor_data <- churn_data |>
  select(c(usage_vars,coverage_vars,sub_vars,service_vars,eq_vars,dem_vars_dich,dem_vars_other)) |> 
  na.omit()
```

```{r}
data |> 
  ggplot(aes(x=MOU,color=CHURN)) +
  geom_density()
```




```{r}
pairs_data <- data |> 
  select(c(all_of(target_vars),all_of(sub_vars)))

pairs(pairs_data)
plot
```

```{r,fig.height=15,fig.width=15}
res <- cor_data |> 
  #select(1:40) |> 
  cor()
#install.packages("corrplot")
library(corrplot)
corrplot(res, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```







```{r}
set.seed(10)
data_split <- initial_split(data, prop = 0.75, strata = CHURN)

data_train <- data_split |> 
  training()

data_test <- data_split |> 
  testing()

nrow(data_train)
nrow(data_test)
```

```{r}
model<- logistic_reg() %>%
        set_engine("glm") %>%
        set_mode("classification") %>%
        fit(CHURN~., data = data_train)

model_tidied <- tidy(model)
model_tidied

model_tidied_odds <- tidy(model, exponentiate = TRUE)
model_tidied_odds

model_tidied_odds %>%
  filter(p.value < 0.05)
```


## TRAINING DATA

```{r}
pred_class <- predict(model,
                      new_data = data_train,
                      type = "class")

pred_class[1:5,]

pred_proba <- predict(model,
                      new_data = data_train,
                      type = "prob")

pred_proba[1:5,]

pred_results <- data_train %>%
  select(CHURN) %>%
  bind_cols(pred_class, pred_proba)

pred_results[1:5, ]
```

```{r}
conf_mat(pred_results, truth = CHURN,
         estimate = .pred_class)
```

```{r}
custom_metrics <- metric_set(accuracy, sens, yardstick::spec, precision, recall, f_meas, kap, mcc)

custom_metrics(pred_results,
               truth = CHURN,
               estimate = .pred_class)
```

```{r}
roc_auc(pred_results,
        truth = CHURN,
        .pred_0)

pred_results %>%
  roc_curve(truth = CHURN, .pred_0) %>%
  autoplot()
```




## TESTING DATA

```{r}
pred_class <- predict(model,
                      new_data = data_test,
                      type = "class")

pred_class[1:5,]

pred_proba <- predict(model,
                      new_data = data_test,
                      type = "prob")

pred_proba[1:5,]

pred_results <- data_test %>%
  select(CHURN) %>%
  bind_cols(pred_class, pred_proba)

pred_results[1:5, ]
```

```{r}
conf_mat(pred_results, truth = CHURN,
         estimate = .pred_class)
```

```{r}
custom_metrics <- metric_set(accuracy, sens, yardstick::spec, precision, recall, f_meas, kap, mcc)

custom_metrics(pred_results,
               truth = CHURN,
               estimate = .pred_class)
```

```{r}
roc_auc(pred_results,
        truth = CHURN,
        .pred_0)

pred_results %>%
  roc_curve(truth = CHURN, .pred_0) %>%
  autoplot()
```




